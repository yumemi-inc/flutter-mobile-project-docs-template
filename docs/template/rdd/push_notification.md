<!--
このドキュメントは「Push通知」機能の詳細機能要件定義書のテンプレートです。

【使い方】
- 本テンプレートはPush通知機能の詳細な要件を整理・共有するためのものです。
- 必要に応じて要件を追加・修正してください。
- 用語や表現の統一、重複の回避に注意してください。

【カラム説明】
| カテゴリ | 機能名 | 機能の説明 | 備考 | テクニカルノート |
|-|-|-|-|-|
| カテゴリ | 機能の名称 | 機能説明 | 補足事項や関連情報 | バリデーションの定義など技術情報 |
-->

# Push通知機能 詳細機能要件定義書テンプレート

## 概要

<!--
このセクションには、Push通知機能の目的や背景、利用シーンなどを記載してください。
-->

本ドキュメントは、スマートフォンアプリにおける「Push通知」機能の詳細な要件を定義します。ユーザーに対して適切なタイミングで通知を配信し、アプリの利便性やリテンション向上を目的とします。

## 機能一覧

<!--
このセクションには、Push通知機能に含まれる主な機能を一覧で記載してください。
- 例としてよくある業務要件を記載しています。不要なものは削除し、必要に応じて追加・修正してください。
-->

<!-- markdownlint-disable MD033 -->

| カテゴリ | 機能名 | 機能の説明 | 備考 | テクニカルノート |
|-|-|-|-|-|
| FCM トークン | 発行 | 端末は、ログイン機能内の認証を行う前にFCM 登録トークンを再発行する（※)<br><br>発行した新規のFCM 登録トークンを 認証API リクエストでサーバに送信する。サーバ側は受け取ったFCM 登録トークンをユーザー ID と紐づけて保存する。 | ※ログインしているユーザーに対してプッシュ通知を送信する必要があるため、FCM登録トークンはログイン処理時に行う必要がある。 | |
| | 削除 | **想定ケース**<br>手動ログアウト<br>強制ログアウト<br>バックグラウンド状態からの復帰時ログアウト<br><br>アプリがログアウト処理を実施する際に、サーバへログアウト API リクエストする。サーバ側はユーザー ID に紐づいたFCM登録トークンのデータを削除する。<br><br>**削除できないケース**<br>アプリを終了して、アプリ内のログイン状態が未ログイン状態になるとき |  | |
| 通知機能 | お知らせの受信 | お知らせが届いた場合、新着お知らせの受信通知を受信する。<br><br>受信した通知を押下した場合、お知らせ画面が開く。| | |
| | 新着メッセージの受信 | ユーザーを含む宛先のメッセージが届いた場合、新着メッセージの受信通知を受信する。<br><br>受信した通知を押下した場合、メッセージ画面が開く。| | |

<!-- markdownlint-enable MD033 -->

## シナリオ

<!--
このセクションには、Push通知機能の主な利用シナリオやユーザーフローを記載してください。
- 例としてよくある業務要件を記載しています。不要なものは削除し、必要に応じて追加・修正してください。
-->

### 新着メッセージの受信通知

1. (スマホ/PC 側）ユーザー A ユーザー B 宛に連絡メッセージ（新規作成、返信、転送）を作成し、送信する
2. （サーバ側）サーバはメッセージを受け取り、宛先に含まれたユーザー B のスマホ端末に新着メッセージのプッシュ通知を送信する
3. (スマホ側）ユーザー B は端末に届いたプッシュ通知を押下する
4. (スマホ側）端末はアプリ上でホーム画面を開く

## FCM 登録トークンを発行するタイミング

<!--
このセクションには、FCM登録トークンをアプリが発行・更新するタイミングを記載してください。
- 例としてよくある業務要件を記載しています。不要なものは削除し、必要に応じて追加・修正してください。
-->

- 端末は、ログイン機能内の認証を行う前にFCM 登録トークンを再発行する。
- 発行した新規のFCM 登録トークンを認証 API リクエストでサーバに送信する。
- サーバ側は受け取ったFCM 登録トークンをユーザー ID と紐づけて保存する。
  - ログインしているユーザーに対してプッシュ通知を送信する必要があるため、FCM 登録トークンはログイン処理時に行う必要がある。

### サーバからFCM 登録トークンを削除する

#### 想定ケース

- 手動ログアウト
- 強制ログアウト
- バックグラウンド状態からの復帰時ログアウト

アプリがログアウト処理を実施する際に、サーバへログアウト API リクエストする。サーバ側はユーザー ID に紐づいたFCM 登録トークンのデータを削除する。

#### 削除できないケース

- アプリを終了して、アプリ内のログイン状態が未ログイン状態になるとき

## プッシュ通知を受信するアプリの状態一覧

<!--
このセクションには、アプリがどの状態でプッシュ通知を受信できるかを記載してください。
- 例としてよくある業務要件を記載しています。不要なものは削除し、必要に応じて追加・修正してください。
-->
- アプリがフォアグラウンド状態（※1）にあるとき
- アプリがバックグラウンド状態（※2）にあるとき
- アプリがアプリ終了状態（※3）のとき

  - ※1：アプリが開いている状態で、表示または使用されている
  - ※2：アプリは開いているが、バックグラウンドで実行されている（最小化されている）。通常、この状態はユーザーがデバイスのホームボタンを押した場合、アプリ スイッチャーを使用して別のアプリに切り替えた場合、アプリを別のタブ（ウェブ）で開いた場合、デバイスが画面オフ状態にしたときに発生する
  - ※3：デバイスがロックされているか、アプリケーションが実行されていない状態。

## ペイロード情報

<!--
このセクションには、Push通知のペイロード（データ構造や含まれる情報）を記載してください。
- 例としてよくある業務要件を記載しています。不要なものは削除し、必要に応じて追加・修正してください。
-->

- ユーザー ID（どのユーザー宛のプッシュ通知かを判定するために必要）
- プッシュ通知の種類

```json
{
    "data" :{
        "user_id": "${ユーザー ID}",
        "notification_type": "${プッシュ通知の種類}",
        ...
    }
}
```

### ペイロードのサイズ制限

- どちらのメッセージ タイプも最大ペイロードは 4 KB です。ただし、Firebase コンソールからメッセージを送信する場合は例外となり、1,024 文字の上限が適用されます。
