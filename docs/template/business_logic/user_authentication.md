<!--
このドキュメントはビジネスロジックの個別詳細仕様書のテンプレートです。

【使い方】
- 各ビジネスロジックの詳細仕様を記載してください
- 入力パラメータ、出力データ、処理フロー、例外処理を詳細に記述してください
- セキュリティ要件、パフォーマンス要件、テスト観点も含めてください
- サンプルを参考に、必要な項目を入力してください
-->

# BL001: ユーザー認証 詳細仕様書

## 1. 概要

メールアドレスとパスワードによるユーザー認証を行い、認証成功時にはJWTトークンを発行するビジネスロジックです。
セキュリティを重視し、アカウントロック機能や認証履歴の記録を含む包括的な認証システムを提供します。

<!--
入力パラメータの記載方法

ビジネスロジックが受け取る入力パラメータを定義します。
各パラメータの型、必須/任意、制約条件、説明を明確に記載してください。

## 記入項目の説明

- パラメータ名：APIやメソッドで使用するパラメータ名
- 型：データ型（string, number, boolean, object, array等）
- 必須：必須パラメータは○、任意は×
- 制約条件：文字数制限、形式、範囲等の制約
- 説明：パラメータの用途と内容

## 記入時の注意点

- パラメータ名は実装時の変数名と一致させる
- 制約条件は具体的に記載する（例：8文字以上、RFC準拠等）
- セキュリティに関わるパラメータは特に詳細に記載する
- 任意パラメータでもログ記録等で重要な場合は用途を明記する
-->
## 2. 入力パラメータ

| パラメータ名 | 型 | 必須 | 制約条件 | 説明 |
|:------------|:---|:-----|:---------|:-----|
| email | string | ○ | RFC 5322準拠のメール形式 | ユーザーのメールアドレス |
| password | string | ○ | 8文字以上、英数字記号含む | ユーザーのパスワード |
| deviceInfo | object | × | - | デバイス情報（ログ記録用） |
| ipAddress | string | × | IPv4/IPv6形式 | クライアントIPアドレス |

### 入力例

```json
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "deviceInfo": {
    "userAgent": "Mozilla/5.0...",
    "platform": "iOS"
  },
  "ipAddress": "192.168.1.100"
}
```

<!--
出力データの記載方法

ビジネスロジックが返すレスポンスデータを定義します。
成功時と失敗時で異なる構造になる場合は、それぞれ分けて記載してください。

## 記入項目の説明

- フィールド名：レスポンスに含まれるフィールド名
- 型：データ型（string, number, boolean, object, array等）
- 説明：フィールドの内容と用途

## 記入時の注意点

- 成功時と失敗時のレスポンス構造を明確に分ける
- セキュリティ情報（トークン等）は適切に説明する
- エラー時のフィールドはクライアント側の処理に必要な情報を含める
- 日時フィールドは形式（ISO 8601等）を明記する
- オブジェクト型の場合は内部構造も別途定義する
-->
## 3. 出力データ

### 成功時

| フィールド名 | 型 | 説明 |
|:------------|:---|:-----|
| isAuthenticated | boolean | 認証結果（true） |
| user | object | ユーザー情報 |
| token | string | JWTアクセストークン |
| refreshToken | string | リフレッシュトークン |
| expiresAt | datetime | トークン有効期限 |

### 失敗時

| フィールド名 | 型 | 説明 |
|:------------|:---|:-----|
| isAuthenticated | boolean | 認証結果（false） |
| errorCode | string | エラーコード |
| errorMessage | string | エラーメッセージ |
| remainingAttempts | number | 残り試行回数 |

### 出力例

```json
// 成功時
{
  "isAuthenticated": true,
  "user": {
    "id": "user123",
    "email": "user@example.com",
    "name": "山田太郎",
    "role": "user"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "rt_abc123def456...",
  "expiresAt": "2024-12-31T23:59:59Z"
}

// 失敗時
{
  "isAuthenticated": false,
  "errorCode": "AUTH_FAILED",
  "errorMessage": "認証に失敗しました",
  "remainingAttempts": 2
}
```

<!--
処理フローの記載方法

ビジネスロジックの処理手順をMermaid図で可視化します。
複雑な分岐や例外処理も含めて、全体の流れを理解しやすく表現してください。

## 記載方法

- Mermaid記法のflowchartを使用してフローチャートを作成
- 処理ステップは四角形、判定は菱形で表現
- 分岐条件は矢印のラベルで明記
- エラー処理や例外ケースも含める
- 開始から終了まで全ての経路を網羅する

## 更新時の注意点

- 処理ステップの追加・変更時はフロー図も更新する
- 複雑になりすぎた場合はサブフローに分割することも検討
- 判定条件は具体的で分かりやすい表現にする
- セキュリティ関連の処理は特に詳細に記載する
-->
## 4. 処理フロー

```mermaid
flowchart TD
    A[開始] --> B[入力値検証]
    B --> C{検証OK?}
    C -->|NG| D[エラー返却]
    C -->|OK| E[ユーザー認証処理]
    E --> F{認証成功?}
    F -->|NG| G[認証失敗処理]
    F -->|OK| H[トークン生成]
    H --> I[成功レスポンス返却]
    G --> J[失敗レスポンス返却]
    D --> K[終了]
    I --> K
    J --> K
```

<!--
詳細処理手順の記載方法

フローチャートで表現した処理を、より詳細なテキストで補足説明します。
各ステップで実行される具体的な処理内容を記載してください。

## 記載方法

- フローチャートの主要ステップごとに詳細を記載
- 処理内容は具体的で実装可能なレベルで記述
- セキュリティ要件や制約事項も含める
- 設定値（閾値、有効期限等）は具体的な数値で記載

## 記入時の注意点

- フローチャートとの整合性を保つ
- 実装時に参照できる詳細レベルで記載
- セキュリティに関わる処理は特に詳細に記述
- 設定値は運用要件に基づいて決定する
-->
### 詳細処理手順

1. **入力値検証**
   - 必須パラメータの存在チェック
   - データ形式・制約の確認

2. **ユーザー認証処理**
   - ユーザー情報の取得
   - 認証情報の照合
   - アカウント状態の確認

3. **認証成功処理**
   - 認証トークンの生成
   - ユーザー情報の取得
   - 認証履歴の記録

4. **認証失敗処理**
   - 失敗履歴の記録
   - セキュリティ対策の実行

<!--
例外処理の記載方法

ビジネスロジックで発生する可能性のあるエラーケースを網羅的に定義します。
各エラーに対する適切な対応方法も含めて記載してください。

## 記入項目の説明

- エラーケース：エラーが発生する状況や条件
- エラーコード：システム内で使用する一意のエラー識別子
- エラーメッセージ：ユーザーに表示するメッセージ
- HTTPステータス：WebAPIの場合のHTTPステータスコード
- 対応：エラー発生時の推奨対応方法

## 記入時の注意点

- セキュリティを考慮してエラーメッセージは適切に設計する
- エラーコードは他のロジックと重複しないよう管理する
- HTTPステータスコードは標準に準拠する
- ユーザビリティを考慮した対応方法を記載する
- システムエラーと業務エラーを明確に分ける
-->
## 5. 例外処理

| エラーケース | エラーコード | エラーメッセージ | HTTPステータス | 対応 |
|:------------|:-------------|:----------------|:---------------|:-----|
| バリデーションエラー | VALIDATION_ERROR | 入力値が正しくありません | 400 | 入力値修正を促す |
| ユーザー未登録 | AUTH_FAILED | 認証に失敗しました | 401 | セキュリティ考慮で詳細は非表示 |
| パスワード不一致 | AUTH_FAILED | 認証に失敗しました | 401 | セキュリティ考慮で詳細は非表示 |
| アカウントロック | ACCOUNT_LOCKED | アカウントがロックされています | 423 | ロック解除時間を表示 |
| アカウント無効 | ACCOUNT_DISABLED | アカウントが無効です | 403 | 管理者への問い合わせを促す |
| システムエラー | INTERNAL_ERROR | 一時的なエラーが発生しました | 500 | 時間をおいて再試行を促す |
